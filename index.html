
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Selección de Personal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PapaParse (para leer CSV) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- jsPDF & AutoTable (para exportar PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Iconos SVG
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        // Cambiado IconTrophy por IconUsers para reflejar selección de personas
        const IconUsers = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const IconRefresh = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>;
        const IconHistory = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>;
        const IconEye = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>;
        const IconCalendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;

        function App() {
            // Estados Principales
            const [activeTab, setActiveTab] = useState('new'); // 'new' | 'history'
            const [participants, setParticipants] = useState([]);
            const [fileName, setFileName] = useState("");
            const [selectionCount, setSelectionCount] = useState(1);
            const [selectedPeople, setSelectedPeople] = useState([]); // Cambiado de winners a selectedPeople
            const [isSelecting, setIsSelecting] = useState(false); // Cambiado de isDrawing
            const [error, setError] = useState("");
            
            // Estado para Historial
            const [history, setHistory] = useState([]);
            const [viewingHistoryItem, setViewingHistoryItem] = useState(null);

            // Cargar historial al iniciar
            useEffect(() => {
                const savedHistory = localStorage.getItem('sorteo_history');
                if (savedHistory) {
                    try {
                        setHistory(JSON.parse(savedHistory));
                    } catch (e) {
                        console.error("Error cargando historial", e);
                    }
                }
            }, []);

            // Utilidad para nombre limpio
            const getCleanFileName = (name) => {
                if (!name) return "Selección de Padrón";
                return name.replace(/\.csv$/i, '');
            };

            // Función para manejar carga de archivo
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.type !== "text/csv" && !file.name.endsWith('.csv')) {
                    setError("Por favor, sube un archivo CSV válido.");
                    return;
                }

                setFileName(file.name);
                setError("");
                setParticipants([]);
                setSelectedPeople([]);
                setViewingHistoryItem(null);

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        const validData = results.data.filter(row => row.Apellido || row.Nombre || row.Matricula);
                        if (validData.length === 0) {
                            setError("El archivo parece estar vacío o no tiene el formato correcto.");
                        } else {
                            setParticipants(validData);
                        }
                    },
                    error: (err) => {
                        setError("Error al leer el archivo: " + err.message);
                    }
                });
            };

            // Función de selección
            const handleSelection = () => {
                if (participants.length === 0) return;
                if (selectionCount > participants.length) {
                    setError(`Solo hay ${participants.length} personas. No puedes seleccionar ${selectionCount}.`);
                    return;
                }

                setError("");
                setIsSelecting(true);
                setSelectedPeople([]);
                setViewingHistoryItem(null);

                setTimeout(() => {
                    const shuffled = [...participants].sort(() => 0.5 - Math.random());
                    const selected = shuffled.slice(0, selectionCount);
                    
                    const newResult = {
                        id: Date.now(),
                        date: new Date().toISOString(),
                        fileName: fileName,
                        selectedPeople: selected, // Guardamos como selectedPeople en el historial
                        totalParticipants: participants.length
                    };

                    setSelectedPeople(selected);
                    
                    // Guardar en historial
                    const updatedHistory = [newResult, ...history];
                    setHistory(updatedHistory);
                    localStorage.setItem('sorteo_history', JSON.stringify(updatedHistory));
                    
                    setIsSelecting(false);
                }, 1500);
            };

            const handleReset = () => {
                setParticipants([]);
                setFileName("");
                setSelectedPeople([]);
                setSelectionCount(1);
                setError("");
                setViewingHistoryItem(null);
            };

            const handleDeleteHistory = (id, e) => {
                e.stopPropagation();
                if(confirm('¿Estás seguro de querer eliminar este registro?')) {
                    const updatedHistory = history.filter(item => item.id !== id);
                    setHistory(updatedHistory);
                    localStorage.setItem('sorteo_history', JSON.stringify(updatedHistory));
                    if (viewingHistoryItem && viewingHistoryItem.id === id) {
                        setViewingHistoryItem(null);
                        setSelectedPeople([]);
                    }
                }
            };

            const handleViewHistory = (item) => {
                setViewingHistoryItem(item);
                setActiveTab('new'); // Cambiamos a la pestaña principal para ver resultados
            };

            // Generador de PDF reutilizable
            const generatePDF = (targetPeople, targetFileName, targetDate) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const cleanName = getCleanFileName(targetFileName);
                const drawDate = new Date(targetDate);
                
                // Título
                doc.setFontSize(18);
                doc.setTextColor(41, 128, 185);
                const splitTitle = doc.splitTextToSize(`Nómina de Seleccionados: ${cleanName}`, 180);
                doc.text(splitTitle, 105, 20, null, null, "center");
                
                // Fecha
                doc.setFontSize(10);
                doc.setTextColor(100);
                const dateStr = drawDate.toLocaleDateString('es-AR', { 
                    year: 'numeric', month: 'long', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                const dateY = 20 + (splitTitle.length * 8); 
                doc.text(`Fecha de selección: ${dateStr}`, 105, dateY, null, null, "center");

                doc.setLineWidth(0.5);
                doc.line(20, dateY + 4, 190, dateY + 4);

                const headers = ["#", "Matrícula", "Apellido y Nombre", "Documento", "Sección"];
                
                const tableData = targetPeople.map((w, index) => {
                    let nombreCompleto = w.Apellido && w.Nombre ? `${w.Apellido}, ${w.Nombre}` : (w.Nombre || w.Apellido || "Sin Nombre");
                    let documento = w.Documento || w.DNI || "-";
                    let matricula = w.Matricula || "-";
                    let seccion = w.Seccion || "-";
                    return [index + 1, matricula, nombreCompleto, documento, seccion];
                });

                doc.autoTable({
                    startY: dateY + 12,
                    head: [headers],
                    body: tableData,
                    theme: 'striped',
                    headStyles: { fillColor: [41, 128, 185] },
                    styles: { fontSize: 10, cellPadding: 3 },
                });

                const pageCount = doc.internal.getNumberOfPages();
                for(let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text('Documento generado automáticamente.', 105, 290, null, null, 'center');
                }

                doc.save(`${cleanName}_Seleccion_${drawDate.getTime()}.pdf`);
            };

            // Determinar qué mostrar en la sección de resultados
            // Nota: Mantenemos retrocompatibilidad con historial antiguo que usaba 'winners'
            const displayPeople = viewingHistoryItem ? (viewingHistoryItem.selectedPeople || viewingHistoryItem.winners) : selectedPeople;
            const displayFileName = viewingHistoryItem ? viewingHistoryItem.fileName : fileName;
            const displayDate = viewingHistoryItem ? viewingHistoryItem.date : new Date();
            const isViewingHistory = !!viewingHistoryItem;

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col items-center max-w-6xl mx-auto">
                    
                    {/* Encabezado */}
                    <header className="mb-8 text-center w-full">
                        <div className="flex justify-center mb-4">
                            <div className="bg-blue-600 p-4 rounded-full shadow-lg text-white">
                                <IconUsers />
                            </div>
                        </div>
                        <h1 className="text-3xl font-bold text-gray-800 break-words">
                            {isViewingHistory ? `Histórico: ${getCleanFileName(displayFileName)}` : getCleanFileName(fileName)}
                        </h1>
                        <p className="text-gray-500 mt-2">
                            {isViewingHistory 
                                ? `Viendo selección del ${new Date(displayDate).toLocaleDateString()}` 
                                : "Sistema de Selección Aleatoria de Padrón."}
                        </p>
                    </header>

                    {/* Navegación de Pestañas */}
                    <div className="flex space-x-2 bg-white p-1 rounded-xl shadow-sm border border-gray-200 mb-6">
                        <button 
                            onClick={() => { setActiveTab('new'); setViewingHistoryItem(null); }}
                            className={`px-6 py-2 rounded-lg text-sm font-medium transition-colors ${activeTab === 'new' ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}
                        >
                            Nueva Selección
                        </button>
                        <button 
                            onClick={() => setActiveTab('history')}
                            className={`px-6 py-2 rounded-lg text-sm font-medium transition-colors ${activeTab === 'history' ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}
                        >
                            Historial
                        </button>
                    </div>

                    <div className="w-full grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                        
                        {/* PANEL IZQUIERDO (Dinámico según Pestaña) */}
                        <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 min-h-[400px]">
                            
                            {activeTab === 'new' ? (
                                <>
                                    <h2 className="text-xl font-semibold mb-4 text-gray-700 flex items-center gap-2">
                                        Configuración
                                    </h2>
                                    
                                    {/* Subida de Archivo */}
                                    {!participants.length && !isViewingHistory ? (
                                        <div className="border-2 border-dashed border-blue-300 rounded-lg p-8 text-center hover:bg-blue-50 transition-colors cursor-pointer relative">
                                            <input type="file" accept=".csv" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                            <div className="flex flex-col items-center text-blue-500">
                                                <IconUpload />
                                                <span className="mt-2 font-medium">Cargar CSV</span>
                                                <span className="text-xs text-gray-400 mt-1">Matricula, Apellido, Nombre...</span>
                                            </div>
                                        </div>
                                    ) : (
                                        isViewingHistory ? (
                                             <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                                <p className="font-semibold text-blue-800">Modo Visualización</p>
                                                <p className="text-sm text-blue-600 mt-1">Estás consultando un registro histórico.</p>
                                                <button onClick={() => setViewingHistoryItem(null)} className="mt-3 text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                                                    Volver a la selección actual
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="bg-green-50 border border-green-200 rounded-lg p-4 flex justify-between items-center mb-4">
                                                <div className="overflow-hidden">
                                                    <p className="font-semibold text-green-800">Archivo Cargado</p>
                                                    <p className="text-sm text-green-600 truncate w-40" title={fileName}>{fileName}</p>
                                                    <p className="text-xs text-green-600 mt-1">{participants.length} personas en lista</p>
                                                </div>
                                                <button onClick={handleReset} className="text-red-500 hover:text-red-700 p-2" title="Eliminar archivo">
                                                    <IconTrash />
                                                </button>
                                            </div>
                                        )
                                    )}

                                    {error && <div className="mt-4 bg-red-50 text-red-600 text-sm p-3 rounded-lg border border-red-200">{error}</div>}

                                    {/* Controles de Selección */}
                                    {!isViewingHistory && (
                                        <div className={`mt-6 transition-opacity ${participants.length ? 'opacity-100' : 'opacity-50 pointer-events-none'}`}>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Cantidad de Personas a Seleccionar</label>
                                            <input 
                                                type="number" 
                                                min="1" 
                                                max={participants.length || 1}
                                                value={selectionCount} 
                                                onChange={(e) => setSelectionCount(parseInt(e.target.value) || 1)}
                                                className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                                            />
                                            <button 
                                                onClick={handleSelection}
                                                disabled={isSelecting}
                                                className="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition active:scale-95 flex justify-center items-center gap-2"
                                            >
                                                {isSelecting ? (
                                                    <><span className="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mr-2"></span>Seleccionando...</>
                                                ) : (
                                                    <><IconRefresh /> Realizar Selección</>
                                                )}
                                            </button>
                                        </div>
                                    )}
                                </>
                            ) : (
                                // LISTA DE HISTORIAL
                                <div className="h-full flex flex-col">
                                    <h2 className="text-xl font-semibold mb-4 text-gray-700 flex items-center gap-2">
                                        Historial de Selecciones
                                    </h2>
                                    {history.length === 0 ? (
                                        <div className="flex-grow flex flex-col items-center justify-center text-gray-400 text-center p-8">
                                            <IconHistory />
                                            <p className="mt-2">No hay registros guardados.</p>
                                        </div>
                                    ) : (
                                        <div className="flex-grow overflow-y-auto max-h-[500px] space-y-3 pr-2">
                                            {history.map((item) => (
                                                <div 
                                                    key={item.id} 
                                                    onClick={() => handleViewHistory(item)}
                                                    className="group bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg p-4 cursor-pointer transition-all relative"
                                                >
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <h3 className="font-semibold text-gray-800 text-sm truncate w-48">{getCleanFileName(item.fileName)}</h3>
                                                            <div className="flex items-center text-xs text-gray-500 mt-1 gap-2">
                                                                <span className="flex items-center gap-1"><IconCalendar /> {new Date(item.date).toLocaleDateString()}</span>
                                                                <span>•</span>
                                                                <span>{new Date(item.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                                            </div>
                                                        </div>
                                                        <span className="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-full">
                                                            {(item.selectedPeople || item.winners || []).length} Seleccionados
                                                        </span>
                                                    </div>
                                                    
                                                    {/* Botón Borrar */}
                                                    <button 
                                                        onClick={(e) => handleDeleteHistory(item.id, e)}
                                                        className="absolute bottom-2 right-2 p-1.5 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                        title="Borrar registro"
                                                    >
                                                        <IconTrash />
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* PANEL DERECHO (Resultados) */}
                        <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 min-h-[400px] flex flex-col">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-xl font-semibold text-gray-700 flex items-center gap-2">
                                    {isViewingHistory ? 'Selección Guardada' : 'Personas Seleccionadas'}
                                </h2>
                                {displayPeople.length > 0 && (
                                    <button 
                                        onClick={() => generatePDF(displayPeople, displayFileName, displayDate)}
                                        className="text-sm bg-gray-800 hover:bg-gray-900 text-white px-3 py-1.5 rounded-lg flex items-center gap-2 transition-colors"
                                    >
                                        <IconDownload /> Exportar PDF
                                    </button>
                                )}
                            </div>

                            <div className="flex-grow bg-gray-50 rounded-lg border border-gray-200 overflow-hidden relative">
                                {isSelecting ? (
                                    <div className="absolute inset-0 flex flex-col items-center justify-center text-blue-500">
                                        <div className="text-4xl font-bold animate-pulse">Procesando...</div>
                                        <p className="text-gray-400 mt-2">Analizando {participants.length} registros</p>
                                    </div>
                                ) : displayPeople.length > 0 ? (
                                    <div className="overflow-y-auto h-full max-h-[500px]">
                                        <table className="w-full text-left border-collapse">
                                            <thead className="bg-gray-100 text-gray-600 text-xs uppercase sticky top-0 z-10">
                                                <tr>
                                                    <th className="p-3 border-b">#</th>
                                                    <th className="p-3 border-b">Matrícula</th>
                                                    <th className="p-3 border-b">Nombre</th>
                                                    <th className="p-3 border-b hidden sm:table-cell">Doc</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {displayPeople.map((person, idx) => (
                                                    <tr key={idx} className="bg-white hover:bg-blue-50 transition-colors animate-fade-in" style={{animationDelay: `${idx * 0.05}s`}}>
                                                        <td className="p-3 font-bold text-blue-600">{idx + 1}</td>
                                                        <td className="p-3 text-gray-800">{person.Matricula}</td>
                                                        <td className="p-3 font-medium">
                                                            {person.Apellido}, {person.Nombre}
                                                            <div className="text-xs text-gray-400 sm:hidden">{person.Documento}</div>
                                                        </td>
                                                        <td className="p-3 text-gray-500 text-sm hidden sm:table-cell">{person.Documento}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-400 p-8 text-center">
                                        {activeTab === 'history' ? (
                                            <>
                                                <IconEye />
                                                <p className="mt-2">Selecciona un registro del historial para ver los detalles.</p>
                                            </>
                                        ) : (
                                            <>
                                                <IconUsers />
                                                <p className="mt-2">Las personas seleccionadas aparecerán aquí.</p>
                                            </>
                                        )}
                                    </div>
                                )}
                            </div>
                            
                            {displayPeople.length > 0 && (
                                <div className="mt-4 text-center text-xs text-gray-400">
                                    Total seleccionados: {displayPeople.length} • Fecha: {new Date(displayDate).toLocaleString()}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>